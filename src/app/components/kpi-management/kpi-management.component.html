<div class="kpi-management-container">
  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1>KPI Management</h1>
      <p>Create, configure KPIs and manage their performance metrics</p>
    </div>
    <button class="btn-primary" (click)="openModal()">
      <span class="plus-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17" fill="none">
          <path d="M8.52053 1.48926V15.4444M1.54297 8.46682H15.4981" stroke="white" stroke-width="1.99359" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span> 
      <span>Add New KPI</span>
    </button>
  </div>

  <!-- KPI Stats Cards -->
  <div class="kpi-stats">
    <div class="stat-card blue">
      <h2>{{ stats?.statistics?.totalKpis }}</h2>
      <p>Total KPIs</p>
    </div>
    <div class="stat-card purple">
      <h2>{{ stats?.statistics?.activeKpis }}</h2>
      <p>Active KPIs</p>
    </div>
    <div class="stat-card peach">
      <h2>{{ stats?.statistics?.higherisbetter }}</h2>
      <p>Higher is Better</p>
    </div>
    <div class="stat-card orange">
      <h2>{{ stats?.statistics?.lowerisbetter }}</h2>
      <p>Lower is Better</p>
    </div>
    <div class="stat-card green">
      <h2>{{ stats?.statistics?.equaltotarget }}</h2>
      <p>Equal to Target</p>
    </div>
  </div>

  <!-- KPI Library -->
  <div class="kpi-library">
    <div class="library-header">
      <h2>KPI Library</h2>
      <p>Manage your organizationâ€™s Key Performance Indicators</p>
    </div>

    <!-- Search + Filters -->
    <!-- <div class="library-controls">
      <input type="text" placeholder="Search KPI by Name, Code..." />
      <div class="filters">
        <select>
          <option>All Categories</option>
          <option>Operational</option>
          <option>Quality</option>
        </select>
        <select>
          <option>All Formulas</option>
          <option>Higher is Better</option>
          <option>Lower is Better</option>
          <option>Equal to Target</option>
        </select>
      </div>
    </div> -->

    <!-- KPI Table -->
    <!-- <div class="table-wrap"> -->
    <!-- </div> -->
<div class="table-wrap">
  <!-- Top controls: Search (left) + Rows per page dropdown (right) -->
  <div class="flex justify-between items-center mb-4">
    <!-- Search on left -->
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input 
        pInputText 
        type="text" 
        (input)="applyGlobalFilter($event, 'contains')" 
        placeholder="Global Search" />
    </span>

    <!-- Rows per page dropdown on right -->
    <p-dropdown 
      [options]="[{label:'5', value:5},{label:'10', value:10},{label:'15', value:15}]"
      [(ngModel)]="rows"
      placeholder="Rows per page"
      (onChange)="dt.rows = rows; dt.reset()">
    </p-dropdown>
  </div>

  <!-- Table -->
  <p-table 
    #dt 
    [value]="kpis" 
    [paginator]="true" 
    [rows]="rows" 
    [globalFilterFields]="['kpiName','kpiCode','kpiCategory','measurementUnit','formulaCode']">

    <!-- Table Headers -->
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="kpiName">KPI Name <p-sortIcon field="kpiName"></p-sortIcon></th>
        <th pSortableColumn="kpiCode">KPI Code <p-sortIcon field="kpiCode"></p-sortIcon></th>
        <th pSortableColumn="kpiCategory">Category <p-sortIcon field="kpiCategory"></p-sortIcon></th>
        <th pSortableColumn="measurementUnit">Unit <p-sortIcon field="measurementUnit"></p-sortIcon></th>
        <th pSortableColumn="formulaCode">Formula <p-sortIcon field="formulaCode"></p-sortIcon></th>
        <th pSortableColumn="isActive">Status <p-sortIcon field="isActive"></p-sortIcon></th>
        <th pSortableColumn="profileCount">Profiles <p-sortIcon field="profileCount"></p-sortIcon></th>
      </tr>
    </ng-template>

    <!-- Table Body -->
    <ng-template pTemplate="body" let-kpi>
      <tr>
        <td>{{ kpi.kpiName }}</td>
        <td>{{ kpi.kpiCode }}</td>
        <td>{{ kpi.kpiCategory }}</td>
        <td>{{ kpi.measurementUnit }}</td>
        <td>{{ kpi.formulaCode }}</td>
        <td>
          <span [ngClass]="kpi.isActive ? 'text-green-600 font-bold' : 'text-red-600 font-bold'">
            {{ kpi.isActive ? 'Active' : 'Inactive' }}
          </span>
        </td>
        <td>{{ kpi.profileCount }}</td>
      </tr>
    </ng-template>

    <!-- Bottom paginator controls -->
    <ng-template pTemplate="paginatorleft" let-state>
      Showing {{ state.first + 1 }} to {{ state.first + state.rows }} of {{ state.totalRecords }} entries
    </ng-template>
  </p-table>
</div>

<!-- Add New KPI Modal -->
<div class="modal-backdrop" *ngIf="showModal">
  <div class="modal">
    <h2>Add New KPI</h2>

    <form [formGroup]="kpiForm" (ngSubmit)="createKpi()">
      <!-- KPI Name -->
      <div class="form-row">
        <label>KPI Name<span class="required">*</span></label>
        <input
          type="text"
          placeholder="eg: Claims Denial Rate..."
          formControlName="kpiName"
        />
        <small class="error" *ngIf="isInvalid('kpiName')">
          KPI Name is required.
        </small>
      </div>

      <!-- KPI Code + Category -->
      <div class="form-grid">
        <div class="form-row">
          <label>KPI Code<span class="required">*</span></label>
          <input
            type="text"
            placeholder="eg: CDR_001"
            formControlName="kpiCode"
          />
          <small class="error" *ngIf="isInvalid('kpiCode')">
            KPI Code is required.
          </small>
        </div>

        <div class="form-row">
          <label>Category<span class="required">*</span></label>
          <select formControlName="kpiCategory">
            <option value="" disabled>Select Category</option>
            <option>Operational</option>
            <option>Quality</option>
            <option>Finance</option>
          </select>
          <small class="error" *ngIf="isInvalid('kpiCategory')">
            Category is required.
          </small>
        </div>
      </div>

      <!-- Description -->
      <div class="form-row">
        <label>Description<span class="required">*</span></label>
        <textarea
          placeholder="eg: Percentage of claims denied..."
          formControlName="kpiDescription"
        ></textarea>
        <small class="error" *ngIf="isInvalid('kpiDescription')">
          Description is required.
        </small>
      </div>

      <!-- Formula + Unit -->
      <div class="form-grid">
        <div class="form-row">
  <label>Formula Type<span class="required">*</span></label>
  <select formControlName="formulaCode">
    <option value="" disabled>Select Formula</option>
    <option *ngFor="let option of formulaOptions" [value]="option.value">
      {{ option.label }}
    </option>
  </select>
  <small class="error" *ngIf="isInvalid('formulaCode')">
    Formula Type is required.
  </small>
</div>

        <div class="form-row">
          <label>Measurement Unit<span class="required">*</span></label>
          <input
            type="text"
            placeholder="eg: Claims/Day"
            formControlName="measurementUnit"
          />
          <small class="error" *ngIf="isInvalid('measurementUnit')">
            Measurement Unit is required.
          </small>
        </div>
      </div>

      <!-- Buttons -->
      <div class="modal-actions">
        <button type="button" class="btn-outline" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="kpiForm.invalid">
          Create KPI
        </button>
      </div>
    </form>
  </div>
</div>

